<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>buscaweas</title>
</head>
<script>
    let obtenidos = [];
    async function GET(url) {
        let urlObj = new URL(url);
        let response = await fetch(urlObj);
        return response.json();           
    }

    function sacarIdDeUrl(url) {
        try {
            let expresion = /^(http[s]?\:\/\/)?myanimelist\.net\/anime\/(\d+)\/.*$/i;
            let resultado = url.match(expresion);
            if (resultado) {
                return Number.parseInt(resultado[2]);
            }
            throw "El enlace proporcionado es incorrecto";
        } catch (e) {
            throw "Enlace mal formado";
        }
    }

    async function obtenerAnime(id) {
        if (!id) {
            throw "Identificador incorrecto";
        }
        let jikanUrl = `https://api.jikan.moe/v4/anime/${id}/full`;
        return await GET(jikanUrl);
    }

    function obtenerRelacionados(anime) {
        if (!anime) {
            throw "No ha proporcionado ningún anime";
        }
        if (anime.data)
            return anime.data.relations;
        return [];
    }

    function anadirAlContenedor(entry) {
        if (entry) {
            let contenedor = document.getElementById("contenedor");
            let listado = document.getElementById("listado");
            if (!listado) {
                listado = document.createElement("ul");
                listado.id = "listado";
                contenedor.appendChild(listado);
            }
            let elemento = document.createElement("li");
            let enlaceElemento = document.createElement("a");
            enlaceElemento.href = entry.url;
            enlaceElemento.target = "_blank";
            enlaceElemento.innerText = entry.name;
            elemento.appendChild(enlaceElemento);
            listado.appendChild(elemento);
        }
    }

    function anadirRelaciones(relaciones) {
        let nuevasUrl = [];
        if (relaciones) {
            relaciones.filter(r => r.relation != "Adaptation").forEach(chingadera => {
                for (entry of chingadera.entry) {
                    if (entry.type === "anime" && obtenidos.filter(wea => wea.mal_id === entry.mal_id).length === 0) {
                        obtenidos.push(entry);
                        nuevasUrl.push(entry.url);
                        anadirAlContenedor(entry);
                    }
                }
            });
        }
        return nuevasUrl;
    }

    async function sagase(url) {
        return new Promise((resolve, reject) => setTimeout(async () => {
            try {
                buscandoEn(url);
                let id = sacarIdDeUrl(url);
                let anime = await obtenerAnime(id);
                let relaciones = obtenerRelacionados(anime);
                let nuevasRelaciones = anadirRelaciones(relaciones);
                for await (let nuevaUrl of nuevasRelaciones) {
                    await sagase(nuevaUrl);
                }
                resolve();
            } catch (error) {
                reject(error);
            }
        }, 1000));
    }

    function buscandoEn(url) {
        let buscando = document.getElementById("buscando");
        buscando.innerText = `BUSCANDO EN: ${url}`;
    }

    function borrarContenido() {
        document.getElementById("contenedor").innerHTML = "";
        obtenidos = [];
    }

    window.onload = () => {
        document.getElementById("formulario").addEventListener("submit", e => {
            e.preventDefault();
            borrarContenido();
            let url = e.currentTarget.elements["url"].value;
            sagase(url).then(() => {
                window.alert(`BÚSQUEDA REALIZADA.\nTOTAL: ${obtenidos.length} relacionados`);
                let buscando = document.getElementById("buscando").innerHTML = "";
            }).catch(err => {
                window.alert("Como el programador es un tolili, o el servidor está tocando las weas, la busqueda ha fallado... Puta bida...");
                console.error(err);
            });
        });
    }
</script>
<body>
    <form id="formulario">
        <input type="text" id="campoUrl" name="url"/>
        <input type="submit" value="COMPROBAR"/>
    </form>
    <div id="buscando"></div>
    <div id="contenedor">
        
    </div>
</body>
</html>