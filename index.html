<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>buscaweas</title>
</head>
<script>
    let omitirResumenes = false;
    let obtenidos = {};
    async function GET(url) {
        let urlObj = new URL(url);
        let response = await fetch(urlObj);
        if (response.status !== 200 && response.status !== 201) {
            throw new Error(`Error ${response.status}: ${response.statusText}`);
        }
        return await response.json();         
    }

    function sacarIdDeUrl(url) {
        try {
            let expresion = /^(http[s]?\:\/\/)?myanimelist\.net\/anime\/(\d+)\/.*$/i;
            let resultado = url.match(expresion);
            if (resultado) {
                return Number.parseInt(resultado[2]);
            }
            throw "El enlace proporcionado es incorrecto";
        } catch (e) {
            throw "Enlace mal formado";
        }
    }

    async function obtenerAnime(id) {
        if (!id) {
            throw "Identificador incorrecto";
        }
        let jikanUrl = `https://api.jikan.moe/v4/anime/${id}/full`;
        return await GET(jikanUrl);
    }

    function obtenerRelacionados(anime) {
        if (!anime) {
            throw "No ha proporcionado ningún anime";
        }
        if (anime.data)
            return anime.data.relations;
        return [];
    }

    function anadirRelaciones(relaciones) {
        let nuevasUrl = [];
        if (relaciones) {
            let omitidos = ["Adaptation"]; 
            if (omitirResumenes) {
                omitidos.push("Summary");
            }
            relaciones.filter(r => !omitidos.includes(r.relation)).forEach(chingadera => {
                for (entry of chingadera.entry) {
                    if (entry.type === "anime" && !obtenidos[entry.mal_id]) {
                        obtenidos[entry.mal_id] = {
                            mal_id: entry.mal_id,
                            url: entry.url
                        };
                        nuevasUrl.push(entry.url);
                    }
                }
            });
        }
        return nuevasUrl;
    }

    function rellenarAnime(anime) {
        if (anime && anime.mal_id) {
            obtenidos[anime.mal_id] = anime;
        }
    }

    function comparador(a, b) {
        if (a.dataset.fecha < b.dataset.fecha)
            return -1;
        if (a.dataset.fecha > b.dataset.fecha)
            return 1;
        return 0;
    }

    function ordenarListado() {
        let listado = document.getElementById("listado");
        if (listado) {
            let elementos = listado.getElementsByTagName("li");
            let arregloElementos = Array.from(elementos);
            arregloElementos.sort(comparador);
            for (elemento of arregloElementos) {
                listado.appendChild(elemento);
            }
        }
    }

    function anadirAlContenedor(anime) {
        if (anime) {
            let contenedor = document.getElementById("contenedor");
            let listado = document.getElementById("listado");
            if (!listado) {
                listado = document.createElement("ul");
                listado.id = "listado";
                contenedor.appendChild(listado);
            }
            let elemento = document.createElement("li");
            let enlaceElemento = document.createElement("a");
            enlaceElemento.href = anime.url;
            enlaceElemento.target = "_blank";
            
            let cadenaFecha = anime.aired ? anime.aired.from : "";
            let ano = (anime.aired && anime.aired.prop && anime.aired.prop.from) ? "" + anime.aired.prop.from.year : "";
            let mes = (anime.aired && anime.aired.prop && anime.aired.prop.from) ? "" + anime.aired.prop.from.month : "";
            if (mes.length < 2) {
                mes = "0" + mes;
            }
            let cadenaMesAno = (ano && mes) ? `${mes}/${ano}` : `${mes}${ano}`;
            
            elemento.dataset.fecha = cadenaFecha;
            enlaceElemento.innerText = `${anime.title}${cadenaMesAno ? ` (${cadenaMesAno})` : ""}`;

            elemento.appendChild(enlaceElemento);
            listado.appendChild(elemento);
            ordenarListado();
        }
    }

    async function sagase(url) {
        return new Promise((resolve, reject) => setTimeout(async () => {
            try {
                buscandoEn(url);
                let id = sacarIdDeUrl(url);
                let anime = await obtenerAnime(id);
                if (anime) {
                    rellenarAnime(anime.data);
                    anadirAlContenedor(anime.data);
                }
                let relaciones = obtenerRelacionados(anime);
                let nuevasRelaciones = anadirRelaciones(relaciones);
                for await (let nuevaUrl of nuevasRelaciones) {
                    await sagase(nuevaUrl);
                }
                resolve();
            } catch (error) {
                reject(error);
            }
        }, 1000));
    }

    function buscandoEn(url) {
        let buscando = document.getElementById("buscando");
        buscando.innerText = `BUSCANDO EN: ${url}`;
    }

    function borrarContenido() {
        document.getElementById("contenedor").innerHTML = "";
        obtenidos = {};
    }

    window.onload = () => {
        document.getElementById("formulario").addEventListener("submit", e => {
            e.preventDefault();
            borrarContenido();
            omitirResumenes = e.currentTarget.elements["resumenes"].checked;
            let url = e.currentTarget.elements["url"].value;
            sagase(url).then(() => {
                window.alert(`BÚSQUEDA REALIZADA.\nTOTAL: ${Object.keys(obtenidos).length} relacionados`);
                let buscando = document.getElementById("buscando").innerHTML = "";
                console.log(obtenidos);
            }).catch(err => {
                window.alert("Como el programador es un tolili, o el servidor está tocando las weas, la busqueda ha fallado... Puta bida...");
                console.error(err);
            });
        });
    }
</script>
<body>
    <form id="formulario">
        <input type="text" id="campoUrl" name="url"/>
        <input type="submit" value="COMPROBAR"/>
        <br/>
        <input type="checkbox" id="res" name="resumenes" value="1"/>
        <label for="res">Omitir resúmenes</label>
    </form>
    <div id="buscando"></div>
    <div id="contenedor">
        
    </div>
</body>
</html>